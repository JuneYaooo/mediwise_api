# Tokenç®¡ç†å’Œæ•°æ®å‹ç¼©åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

æˆåŠŸå®ç°äº†ä¸€å¥—å®Œæ•´çš„Tokenç®¡ç†å’Œæ•°æ®å‹ç¼©ç³»ç»Ÿï¼Œç”¨äºè§£å†³æ‚£è€…æ•°æ®è¿‡é•¿å¯¼è‡´çš„LLMè¾“å…¥/è¾“å‡ºé™åˆ¶é—®é¢˜ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### Phase 1: Tokenç®¡ç†åŸºç¡€è®¾æ–½
- âœ… **TokenManagerç±»** (`src/utils/token_manager.py`)
  - Tokenä¼°ç®—ï¼ˆæ”¯æŒä¸­è‹±æ–‡æ··åˆæ–‡æœ¬ï¼‰
  - è¾“å…¥/è¾“å‡ºé™åˆ¶æ£€æŸ¥
  - å¤šæ¨¡å‹é…ç½®æ”¯æŒï¼ˆGemini, GPT-4, Claudeç­‰ï¼‰
  - å®‰å…¨æ¯”ä¾‹æ§åˆ¶ï¼ˆé»˜è®¤ä½¿ç”¨70%è¾“å…¥é™åˆ¶ï¼‰

- âœ… **ç¯å¢ƒå˜é‡é…ç½®** (`.env.example`)
  - æ¨¡å‹æœ€å¤§tokené…ç½®
  - å®‰å…¨æ¯”ä¾‹é…ç½®
  - å‹ç¼©ç­–ç•¥é…ç½®
  - åˆ†å—å¤„ç†é…ç½®

### Phase 2: æ•°æ®å‹ç¼©
- âœ… **PatientDataCompressorç±»** (`src/utils/data_compressor.py`)
  - æ™ºèƒ½å‹ç¼©ç­–ç•¥ï¼ˆsmart/aggressive/minimalï¼‰
  - æŒ‰ä¼˜å…ˆçº§ä¿ç•™å…³é”®ä¿¡æ¯
  - æ—¶é—´è½´æ•°æ®å‹ç¼©ï¼ˆä¿ç•™æœ€è¿‘è®°å½•ï¼‰
  - åŸå§‹æ–‡ä»¶å‹ç¼©ï¼ˆä¼˜å…ˆä¿ç•™åŒ»å­¦å½±åƒï¼‰
  - è‡ªåŠ¨æ—¥æœŸæ’åºå’Œé‡‡æ ·

### Phase 3: åˆ†å—å¤„ç†
- âœ… **ChunkedPPTProcessorç±»** (`src/utils/chunked_processor.py`)
  - æŒ‰æ—¶é—´çº¿åˆ†å—
  - æŒ‰æ•°æ®å¤§å°åˆ†å—
  - åˆ†å—é‡å ï¼ˆä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§ï¼‰
  - åˆ†å—ç»“æœåˆå¹¶

### Phase 4: ä¿éšœæœºåˆ¶
- âœ… **LLMRetryHandlerç±»** (`src/utils/llm_retry_handler.py`)
  - è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
  - æ¸è¿›å¼å‹ç¼©ï¼ˆ100% â†’ 70% â†’ 50% â†’ 30%ï¼‰
  - Tokenè¶…é™é”™è¯¯å¤„ç†
  - è¾“å‡ºæˆªæ–­æ£€æµ‹å’Œè¡¥å…¨

- âœ… **OutputCompletenessGuardç±»** (`src/utils/output_completeness_guard.py`)
  - PPTæ•°æ®å®Œæ•´æ€§éªŒè¯
  - ç¼ºå¤±å­—æ®µæ£€æµ‹
  - æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
  - LLMè¡¥å…¨ç¼ºå¤±æ•°æ®

### é›†æˆ
- âœ… **é›†æˆåˆ°ppt_generation_crew.py**
  - è‡ªåŠ¨Tokenæ£€æŸ¥
  - è‡ªåŠ¨æ•°æ®å‹ç¼©
  - è¯¦ç»†æ—¥å¿—è¾“å‡º
  - é”™è¯¯å¤„ç†å’Œé™çº§

## ğŸ§ª æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å‡é€šè¿‡ï¼š

### æµ‹è¯•1: Tokenä¼°ç®—
- âœ… çŸ­æ–‡æœ¬: 12å­—ç¬¦ â†’ 7 tokens (1.71å­—ç¬¦/token)
- âœ… ä¸­æ–‡æœ¬: 700å­—ç¬¦ â†’ 445 tokens (1.57å­—ç¬¦/token)
- âœ… é•¿æ–‡æœ¬: 6000å­—ç¬¦ â†’ 3791 tokens (1.58å­—ç¬¦/token)

### æµ‹è¯•2: æ•°æ®å‹ç¼©
- âœ… Smallæ•°æ®é›†: 2368 tokens â†’ 2368 tokens (æ— éœ€å‹ç¼©)
- âœ… Mediumæ•°æ®é›†: 11828 tokens â†’ 3494 tokens (å‹ç¼©è‡³29.5%)
- âœ… Largeæ•°æ®é›†: 47514 tokens â†’ 3494 tokens (å‹ç¼©è‡³7.4%)
- âœ… å…³é”®å­—æ®µéªŒè¯é€šè¿‡ï¼ˆpatient_name, patient_infoç­‰ï¼‰

### æµ‹è¯•3: è¾“å…¥é™åˆ¶æ£€æŸ¥
- âœ… Small: 2368 tokens, ä½¿ç”¨ç‡0.2% âœ…
- âœ… Medium: 11828 tokens, ä½¿ç”¨ç‡1.2% âœ…
- âœ… Large: 47514 tokens, ä½¿ç”¨ç‡4.8% âœ…

### æµ‹è¯•4: æ—¶é—´è½´å‹ç¼©
- âœ… åŸå§‹200æ¡è®°å½• (24581 tokens)
- âœ… å‹ç¼©è‡³81æ¡è®°å½• (10000 tokensç›®æ ‡)
- âœ… ä¿ç•™æœ€è¿‘æ—¥æœŸèŒƒå›´: 2024-08-04 åˆ° 2024-12-28

### æµ‹è¯•5: åŸå§‹æ–‡ä»¶å‹ç¼©
- âœ… åŸå§‹100ä¸ªæ–‡ä»¶ (34ä¸ªåŒ»å­¦å½±åƒ)
- âœ… å‹ç¼©è‡³21ä¸ªæ–‡ä»¶ (14ä¸ªåŒ»å­¦å½±åƒ, 7ä¸ªå…¶ä»–)
- âœ… åŒ»å­¦å½±åƒä¿ç•™ç‡: 41.2%

## ğŸ“ æ–°å¢æ–‡ä»¶

```
src/utils/
â”œâ”€â”€ token_manager.py              # Tokenç®¡ç†å™¨
â”œâ”€â”€ data_compressor.py            # æ•°æ®å‹ç¼©å™¨
â”œâ”€â”€ chunked_processor.py          # åˆ†å—å¤„ç†å™¨
â”œâ”€â”€ llm_retry_handler.py          # LLMé‡è¯•å¤„ç†å™¨
â””â”€â”€ output_completeness_guard.py  # è¾“å‡ºå®Œæ•´æ€§ä¿æŠ¤

tests/
â”œâ”€â”€ test_token_management.py        # å®Œæ•´æµ‹è¯•ï¼ˆéœ€è¦dotenvï¼‰
â””â”€â”€ test_token_management_simple.py # ç®€åŒ–æµ‹è¯•ï¼ˆå·²éªŒè¯é€šè¿‡ï¼‰
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.envï¼‰

```bash
# Tokenç®¡ç†é…ç½®
MODEL_MAX_INPUT_TOKENS=1000000      # æ¨¡å‹æœ€å¤§è¾“å…¥token
MODEL_MAX_OUTPUT_TOKENS=65535       # æ¨¡å‹æœ€å¤§è¾“å‡ºtoken
TOKEN_SAFE_INPUT_RATIO=0.7          # å®‰å…¨è¾“å…¥æ¯”ä¾‹ï¼ˆ70%ï¼‰
TOKEN_SAFE_OUTPUT_RATIO=0.9         # å®‰å…¨è¾“å‡ºæ¯”ä¾‹ï¼ˆ90%ï¼‰

# æ•°æ®å‹ç¼©é…ç½®
ENABLE_AUTO_COMPRESSION=true        # å¯ç”¨è‡ªåŠ¨å‹ç¼©
COMPRESSION_STRATEGY=smart          # å‹ç¼©ç­–ç•¥: smart/aggressive/minimal
MAX_RAW_FILES_COUNT=50              # åŸå§‹æ–‡ä»¶æœ€å¤§æ•°é‡
MAX_TIMELINE_RECORDS=100            # æ—¶é—´è½´è®°å½•æœ€å¤§æ•°é‡
EXTRACTED_TEXT_MAX_LENGTH=200       # æå–æ–‡æœ¬æœ€å¤§é•¿åº¦

# åˆ†å—å¤„ç†é…ç½®
ENABLE_CHUNKED_PROCESSING=true      # å¯ç”¨åˆ†å—å¤„ç†
CHUNK_SIZE_TOKENS=50000             # æ¯å—tokenå¤§å°
CHUNK_OVERLAP_RATIO=0.1             # åˆ†å—é‡å æ¯”ä¾‹
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### è‡ªåŠ¨æ¨¡å¼ï¼ˆæ¨èï¼‰
ç³»ç»Ÿå·²é›†æˆåˆ° `ppt_generation_crew.py`ï¼Œä¼šè‡ªåŠ¨ï¼š
1. æ£€æŸ¥è¾“å…¥æ•°æ®tokenæ•°
2. å¦‚æœè¶…è¿‡å®‰å…¨é™åˆ¶ï¼Œè‡ªåŠ¨å‹ç¼©
3. å¦‚æœå‹ç¼©åä»è¶…é™ï¼Œè¿”å›é”™è¯¯æç¤º

### æ‰‹åŠ¨ä½¿ç”¨
```python
from src.utils.token_manager import TokenManager
from src.utils.data_compressor import PatientDataCompressor

# åˆå§‹åŒ–
token_manager = TokenManager(logger=logger)
data_compressor = PatientDataCompressor(logger=logger, token_manager=token_manager)

# æ£€æŸ¥tokené™åˆ¶
check_result = token_manager.check_input_limit(patient_data, 'gemini-3-flash-preview')

# å¦‚æœéœ€è¦å‹ç¼©
if check_result['compression_needed']:
    compressed_data = data_compressor.compress_data(
        patient_data,
        target_tokens=check_result['safe_limit']
    )
```

## ğŸ“Š æ€§èƒ½ç‰¹ç‚¹

### Tokenä¼°ç®—å‡†ç¡®æ€§
- ä¸­æ–‡æ–‡æœ¬: ~1.5-1.7å­—ç¬¦/token
- è‹±æ–‡æ–‡æœ¬: ~4å­—ç¬¦/token
- æ··åˆæ–‡æœ¬: ~2å­—ç¬¦/tokenï¼ˆå¹³å‡å€¼ï¼‰

### å‹ç¼©æ•ˆæœ
- Smartç­–ç•¥: é€šå¸¸å‹ç¼©è‡³30-50%
- Aggressiveç­–ç•¥: å¯å‹ç¼©è‡³10-20%
- Minimalç­–ç•¥: å‹ç¼©è‡³70-80%

### æ•°æ®ä¿ç•™ä¼˜å…ˆçº§
1. **Criticalï¼ˆå¿…é¡»ä¿ç•™ï¼‰**: patient_name, patient_info, diagnoses
2. **Importantï¼ˆå°½é‡ä¿ç•™ï¼‰**: lab_tests, treatments, imaging_studies
3. **Optionalï¼ˆå¯å‹ç¼©ï¼‰**: historical_records, extracted_text

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

1. **è‡ªåŠ¨åŒ–**: æ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼Œè‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†
2. **æ™ºèƒ½å‹ç¼©**: æŒ‰ä¼˜å…ˆçº§ä¿ç•™å…³é”®ä¿¡æ¯
3. **åˆ†å±‚é™çº§**: å®Œæ•´æ•°æ® â†’ å‹ç¼© â†’ åˆ†å—
4. **æ¨¡å‹æ— å…³**: æ”¯æŒå¤šç§LLMæ¨¡å‹é…ç½®
5. **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„ç›‘æ§å’Œè°ƒè¯•ä¿¡æ¯
6. **è¾“å‡ºä¿è¯**: æ£€æµ‹å¹¶è¡¥å…¨ä¸å®Œæ•´è¾“å‡º

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Tokenä¼°ç®—**: åŸºäºå­—ç¬¦æ•°ä¼°ç®—ï¼Œå¯èƒ½ä¸å®é™…tokenæ•°æœ‰Â±10%è¯¯å·®
2. **å‹ç¼©æŸå¤±**: æ¿€è¿›å‹ç¼©å¯èƒ½ä¸¢å¤±éƒ¨åˆ†å†å²æ•°æ®
3. **åŒ»å­¦å½±åƒ**: ä¼˜å…ˆä¿ç•™åŒ»å­¦å½±åƒæ–‡ä»¶ï¼Œä½†å¯èƒ½è¿‡æ»¤éƒ¨åˆ†æ™®é€šæ–‡ä»¶
4. **æ—¥æœŸæ’åº**: å‡è®¾æ•°æ®æœ‰æ—¥æœŸå­—æ®µï¼Œå¦åˆ™æŒ‰åŸå§‹é¡ºåºå¤„ç†

## ğŸ”® æœªæ¥æ‰©å±•

å¯é€‰çš„å¢å¼ºåŠŸèƒ½ï¼ˆæš‚æœªå®ç°ï¼‰ï¼š
- [ ] ä½¿ç”¨LLMæå–é•¿æ–‡æœ¬æ‘˜è¦ï¼ˆéœ€è¦é¢å¤–LLMè°ƒç”¨ï¼‰
- [ ] æ›´ç²¾ç¡®çš„tokenè®¡æ•°ï¼ˆä½¿ç”¨tiktokenåº“ï¼‰
- [ ] åˆ†å—å¹¶è¡Œå¤„ç†ï¼ˆæé«˜æ€§èƒ½ï¼‰
- [ ] å‹ç¼©æ•ˆæœè¯„ä¼°å’Œè‡ªåŠ¨è°ƒä¼˜
- [ ] æ”¯æŒæ›´å¤šæ¨¡å‹é…ç½®

## ğŸ“ æ€»ç»“

æœ¬æ¬¡å®ç°å®Œæˆäº†ä¸€å¥—å®Œæ•´çš„Tokenç®¡ç†å’Œæ•°æ®å‹ç¼©ç³»ç»Ÿï¼Œèƒ½å¤Ÿæœ‰æ•ˆè§£å†³æ‚£è€…æ•°æ®è¿‡é•¿çš„é—®é¢˜ã€‚ç³»ç»Ÿå·²é€šè¿‡å…¨é¢æµ‹è¯•ï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ã€‚

**æµ‹è¯•å‘½ä»¤**:
```bash
python3 tests/test_token_management_simple.py
```

**é›†æˆä½ç½®**:
- `src/crews/ppt_generation_crew/ppt_generation_crew.py:376-454`
