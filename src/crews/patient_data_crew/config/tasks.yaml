get_disease_config_task:
  description: >
    根据患者信息识别疾病并获取相应的配置信息。支持识别多个疾病（主要疾病通常2-3种）。

    输入信息:
    患者描述: {patient_info}

    工作流程(必须严格按照以下步骤执行):

    步骤1: 获取所有可用疾病
    - 调用"获取疾病列表工具"获取系统中所有可用的疾病列表
    - 不需要任何参数,直接调用即可

    步骤2: 识别患者的所有疾病
    - 仔细分析输入的患者信息,从步骤1获取的疾病列表中,判断患者可能患有哪些疾病
    - 考虑疾病的同义词、简称、别名等(如"肝癌"、"肝细胞癌"、"HCC"等)
    - 通常一个患者可能有2-3种主要疾病,识别所有相关的疾病
    - 按疾病的重要性排序(主要疾病在前)

    步骤3: 批量查询疾病配置
    - 调用"查询疾病配置工具",输入识别到的所有疾病ID或疾病名称(用逗号分隔)
    - 例如: 'liver_cancer,肺癌' 或 '肝癌,lung_cancer,胃癌'
    - 同时将患者信息作为patient_input参数传入

    步骤4: 分析和输出结果
    - 提取并返回所有疾病的配置信息列表,每个疾病包括:
      * disease_id: 疾病ID
      * disease_name: 疾病名称
      * lab_test_indicators: 实验室检验指标筛选配置
      * key_decision_indicators: 关键决策指标
      * highlight_indicators: 重点标注指标
      * trend_chart_indicators: 趋势折线图指标
      * mdt_report_indicators: MDT报告指标集

    注意事项:
    - 如果无法明确识别任何疾病,返回通用配置(general)
    - 如果患者信息不足,提示需要补充更多信息
    - 如果只识别到一个疾病也没问题,返回单个疾病的配置列表
    - 如果识别到多个疾病,返回所有疾病的配置列表

  expected_output: >
    成功时,返回JSON格式的疾病配置列表:
    {{
      "status": "success",
      "count": 2,
      "primary_diseases": ["liver_cancer", "lung_cancer"],
      "configs": [
        {{
          "disease_id": "liver_cancer",
          "disease_name": "肝癌",
          "lab_test_indicators": {{}},
          "key_decision_indicators": [],
          "highlight_indicators": [],
          "trend_chart_indicators": [],
          "mdt_report_indicators": {{}}
        }},
        {{
          "disease_id": "lung_cancer",
          "disease_name": "肺癌",
          "lab_test_indicators": {{}},
          "key_decision_indicators": [],
          "highlight_indicators": [],
          "trend_chart_indicators": [],
          "mdt_report_indicators": {{}}
        }}
      ]
    }}

    如果识别失败,返回:
    {{
      "status": "not_found",
      "message": "无法识别疾病,请补充更多信息",
      "configs": []
    }}

    如果部分疾病未找到配置:
    {{
      "status": "success",
      "count": 1,
      "warning": "部分疾病未找到配置: 某疾病名",
      "not_found_diseases": ["某疾病名"],
      "configs": [...]
    }}

  agent: disease_config_agent

preprocess_files_task:
  description: >
    从用户上传的部分文件中提取与患者相关的临床和医疗信息，将文件内容精简为能够被模型高效处理的格式。
    
    请注意：
    1. 每个文件可能包含大量内容，你需要专注于提取与患者病情、诊断、治疗和医疗历史相关的客观信息
    2. 对于医疗检验报告，提取所有检验值和参考范围，尤其是超出参考范围的检验值
    3. 对于病历，提取诊断、主诉、现病史、既往史等客观记录
    4. 对于医学文献或指南，只提取与患者当前情况直接相关的客观内容
    5. 删除重复信息，保留最新的客观信息
    6. 若文件名中包含"(Part X/Y)"格式，表示这是大文件的一个分块。处理大文件分块时：
       - 关注这个分块中的客观信息，但不要重复之前已经提取过的基本信息
       - 对于检验报告分块，提取所有检验值
       - 保持信息的上下文完整性，确保能理解片段的意义
    
    请处理以下批次中的文件，结合原始患者描述：
    [系统日期]: {current_date}
    [患者描述]: {patient_info}
    
    
    待处理文件（本批次）：
    {files_batch}
    
  expected_output: >
    返回提取并精简后的患者信息文本（不要使用JSON格式），仅包含与临床诊断 检查检验结果 和治疗直接相关的客观信息，过滤掉无效模板和无关的患者信息，病理与影像等要尽量保持原文重要叙述，需要包含日期，比如下面这些信息(有的就提，没有的或者不相关的就算了)：
    - 基本信息（年龄、性别、主诉）
    - 现病史（按时间顺序）
    - 既往史
    - 检查检验结果（标注超出参考范围的值）
    - 诊断及处理
    - 其他客观信息

  agent: file_preprocessor
  
process_patient_data_task:
  description: >
    从输入的患者临床描述中提取所有相关客观信息，构建时间轴或者更新当前患者时间轴，并按类别整理详细信息。确保使用统一、标准化的字段格式，便于前端展示。时间尽量转换为标准的yyyy-MM-dd格式，若患者当前最近一次询问或者信息没有提供具体时间，则使用当前日期作为默认值。如果是病史描述，或者历史的医疗资料，肯定非当天的，或者非当前的疾病情况，且没有具体时间的，用"时间不详"作为默认值：

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。
    配置格式为: {{"status": "success", "count": N, "configs": [...]}}
    每个config包含: disease_id, disease_name, lab_test_indicators, key_decision_indicators等字段。
    根据疾病配置中的指标字段（lab_test_indicators, key_decision_indicators等），调整数据提取的重点。
    如果患者有多个疾病，需要综合所有疾病的配置进行数据提取。

    **增量更新模式：**
    如果提供了现有时间轴数据，你需要：
    1. 保留现有时间轴中的所有历史数据，不要删除或修改已有的时间轴条目
    2. 将新的患者信息与现有时间轴合并，添加新的时间轴条目或更新相关条目
    3. 确保时间轴按时间顺序排列，新信息应插入到正确的时间位置
    4. 如果新信息与现有时间轴中的某个时间点相关，应更新该条目而不是创建重复条目
    5. 保持患者基本信息的一致性，如果有冲突以最新信息为准

    [系统日期]: {current_date}
    [患者描述]: {patient_info}
    [当前患者时间轴]: {patient_timeline}
    [现有时间轴数据]（如有）: {existing_timeline}

    格式化要求：
    1.核心要求：构建时间轴时，请严格遵循“临床事件/阶段”为最高层级的原则。一次门诊、一次住院、一个治疗周期应作为一个独立的时间轴条目（timeline entry）。禁止将同一次临床事件中的不同检查类型（如检验、影像）拆分成多个时间轴条目。比如初诊初治、xx手术治疗、
      正确做法：将为同一临床目的、在相近时间内完成的不同类型的诊疗活动，归并到同一个时间轴条目下，并使用该临床事件（如“门诊复查”）作为标题title。条目内部再使用不同的data_blocks（如“检验”、“检查”）来组织不同类型的数据。
      举例说明：
        错误示范：
        timeline[0]: {{ title: "门诊复查 - 影像学评估", ... }}
        timeline[1]: {{ title: "门诊复查 - 肿瘤标志物监测", ... }}
        正确示范：
        timeline[0]: {{ title: "2025年4月门诊复查", type: "visit", ... }}
        data_blocks[0]: {{ block_type: "检查", block_title: "上腹CT增强", ... }}
        data_blocks[1]: {{ block_type: "检验", block_title: "肿瘤标志物检测", ... }} (如果这次复查也抽血了)
      时间相近性原则：如果多项检查、检验或处置发生在同一周内，且属于同一临床决策流程（如一次住院期间的术前检查、或一次门诊复查的全面评估），强烈建议将它们归入同一个时间轴条目。仅当时间间隔较长（如超过1-2周）且临床目的明显不同时，才考虑拆分。
    2. 在每个临床阶段的条目内，将同类信息（如所有"检验"结果，所有"影像"报告）合并到单一的data_block中，不要分散。例如，一次"术前准备"阶段的所有化验都应放在一个"检验"类型的data_block里。
    3. 不同类型的数据应放入不同的data_block，例如"检验"和"检查"分别放入不同的data_block。
    4. 如果当前患者时间轴中没有包含当前的医疗事件，则需要将当前的医疗事件添加到当前患者时间轴中。
    5. 对于影像病理报告要尽量保持原文重要叙述包括大小之类的，对于检验要提取所有检验值，并标注超出参考范围的值。
    6. **重要**：对于检验指标的提取，使用疾病识别工具获取的配置中的lab_test_indicators字段，只提取配置中列出的检验指标。如果未识别到特定疾病或配置为空，则提取所有检验指标。
    
    
  expected_output: >
    返回JSON格式的结构化患者数据，包含患者基本信息和时间轴，使用标准化通用字段。
    **重要：所有输出必须使用简体中文，绝对不允许输出Unicode编码符号（如\\u4e2d\\u6587、\\u809d\\u810f等）。必须直接输出可读的中文字符（如"中文"、"肝脏"等）。**
    
    返回格式：
    {{
      "patient_info": {{
        "basic": {{
          "name": "患者姓名(如有,不要出现多个)",
          "age": "年龄",
          "gender": "性别",
          "purpose": "就诊目的",
          "main_complaint": "主诉" # 这个是最近一次患者的主诉,也就是日期最新的一次
        }},
        "medical_history": [
          {{
            "type": "疾病史/手术史/过敏史/家族史/社会史/药物史/其他",
            "name": "具体名称",
            "time": "yyyy-MM-dd格式或者yyyy-MM格式或者yyyy格式（若没有明确日期，推算或者使用时间不详，或者描述也可以）",
            "details": "详细描述"
          }}
        ]
      }},
      "timeline": [
        {{
          "id": "t1",
          "time_period": {{
            "start": "yyyy-MM-dd格式开始日期（若没有明确日期，使用当前日期）",
            "end": "yyyy-MM-dd格式结束日期（若为进行中事件，可为空）"
          }},
          "title": "标题（如初诊/复诊/住院/门诊/术后/术中/术前/化疗/放疗等）",  #title应简洁地概括临床事件的性质，例如“初诊”、“第X次化疗”、“术后第Y天复查”、“YYYY年MM月门诊随访”等。避免在title中直接使用数据块类型（如“检验”、“影像”）
          "type": "visit/exam/surgery/medication/other",
          "location": "医疗机构/科室",
          "summary": "概要描述，格式如疾病状态/手术状态+关键处置/治疗+关键指标+疗效（如有）",
          "key_indicators": "与疾病关键决策点有关的，使用疾病配置中的key_decision_indicators作为参考，提取相关信息，用markdown格式返回。
          "data_blocks": [
            {{
              "block_type": "现病史/诊断/检验/检查/病理/影像/用药/处置/手术/随访/医嘱/其他",
              "block_title": "数据块标题", # block_title用于描述数据块的内容，例如“血常规”、“肝功能”、“上腹部MRI”、“实验室检查”等，对于一次实验室检查归纳到一个数据块里。
              "items": [
                {{
                  "name": "项目名称",
                  "value": "检验关键项目值的拼接或者结果或者病理或者影像的结论", //要点
                  "status": "normal/abnormal/critical/pending", // 仅基于参考范围的客观判断
                  "time": "yyyy-MM-dd格式（若为具体时间点，如同一天内的不同时间，可以是yyyy-MM-dd HH:mm）",
                  "details": "详细描述", 病理与影像需要保持原文，不要精简掉重要信息,不要总结。
                  "file_uuid": "来源文件的UUID（如果基于某个源文件提取，否则为空）",
                  "metadata": {{ 
                    // 可扩展字段，根据block_type不同而包含不同的附加信息
                    // 例如检验可能包含具体检验值，参考范围，用药可能包含剂量频次，病理可能包含病理类型，病理结果详细描述，影像可能包含影像报告详细描述等
                  }},
                  "need_check": true/false // 看起来内容不合理（可能是原始文件在文本化提取的时候发生错误），建议人工检查去查看原始文件
                }}
              ]
            }}
          ]
        }}
      ],
      "summary": {{
        "diagnoses": ["诊断1", "诊断2"], // 记录所有医生确诊的诊断，未确诊的诊断不要记录，不要擅自推断
        "treatments": ["治疗1", "治疗2"], // 记录所有已实施的治疗
        "scheduled_events": [
          {{
            "event_type": "预约/检查/手术/其他",
            "scheduled_time": "yyyy-MM-dd格式预定日期",
            "description": "事件描述"
          }}
        ]
      }},
    }}

  agent: patient_data_processor 

extract_core_points_task:
  description: >
    基于输入生成"患者时间旅程"数据，输出两个元素：

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。
    使用配置中的highlight_indicators和trend_chart_indicators来指导关键信息的提取和标注。

    1) 患者主要事件的时间轴（简明版）：按日期聚合一个时间点对应一条文本，文本不超过100字；将事件类型标注为"主疾病"或"共病"；文本中的关键实体/治疗/诊断/病理/影像要点需使用**加粗**，重要指标或者异常值需标红（使用疾病配置中的highlight_indicators作为参考，使用<span style="color:#d0021b">值</span>）。主要事件包括但不限于：重要检验/检查/病理结果及相应诊断、手术/放疗/化疗/介入/免疫/靶向等治疗、疾病进展或复发、不良反应、入出院节点、重要门急诊随访等。对于手术事件，如果能获知主刀医生的信息，也需要把主刀医生提取出来，放在专门的字段里。对于胃肠镜等大型检查事件，如果能获知检查所在医院的信息，也需要提取出来，放在专门的字段里。

    2) 重要指标的折线数据：从文本与结构化数据中筛选对当前疾病决策最关键的少数数值型指标（使用疾病配置中的trend_chart_indicators作为参考）。按时间升序输出 (time,value) 序列，time 为yyyy-MM-dd或yyyy-MM-dd HH:mm。

    **增量更新模式：**
    如果提供了现有患者时间旅程数据，你需要：
    1. 保留现有时间旅程中的所有历史事件，不要删除已有的事件
    2. 将新的事件与现有时间旅程合并，按时间顺序插入新事件
    3. 对于重要指标数据，将新的数据点添加到现有指标序列中，保持时间升序
    4. 如果发现相同日期的事件，应合并而不是重复
    5. 确保时间旅程的连续性和完整性

    输入：
    [系统日期]: {current_date}
    [患者文本]: {patient_content}
    [患者结构化数据]: {full_structure_data}
    [现有患者时间旅程]: {existing_patient_journey}

    规则：
    - 仅基于提供的信息做客观提取，不得臆测。
    - 同日多事件合并为一条简洁文本（<=100字），优先描述"诊断/治疗/病理/影像/显著异常检验值"。
    - 异常值（高/低/阳性/超参考）需在文本内标红（<span style="color:#d0021b">...</span>），并可在括号里注明参考范围或"↑/↓/阳性"。
    - 关键词（如疾病名、治疗方式、关键结论）需**加粗**。
    - 事件类型仅二选一：主疾病/共病；若与主诊断直接相关则判为主疾病，否则为共病。
    - 日期尽量标准化为yyyy-MM-dd；当仅有月份或相对时间时，尽量推断具体日期，无法确定则使用当前日期。

  expected_output: >
    返回JSON，包含两个顶级字段timeline_journey和indicator_series：
    注意：所有输出必须使用简体中文，不能包含Unicode编码符号（如\\u4e2d\\u6587等）。如果模型输出包含Unicode编码，必须将其解码为正常的中文字符。

    {{
      "timeline_journey": [
        {{
          "date": "yyyy-MM-dd",
          "type": "主疾病|共病",
          "text": "不超过100字；**关键词加粗**；异常值用<span style=\"color:#d0021b\">值</span>标红",
          "chief_surgeon": "如果是手术事件，且有主刀医生信息，才需要提取主刀医生的名字，否则为空",
          "examination_hospital": "如果是胃肠镜等大型检查事件，且有检查所在医院信息，才需要提取医院名称，否则为空"
        }}
      ],
      "indicator_series": [
        {{
          "name": "指标名称",
          "unit": "单位(可选)",
          "series": [ {{ "time": "yyyy-MM-dd", "value": 数值, "is_abnormal": 布尔值 }},
          "normal_min": "正常范围最小值，数值，可选",
          "normal_max": "正常范围最大值，数值，可选" ]
        }}
      ]
    }}
    

  agent: core_points_extractor 

generate_mdt_report_task:
  description: >
    基于患者结构化数据生成标准化的MDT简要报告，用于临床讨论和决策支持。报告需要包含患者基本信息、病史、关键检查结果、影像学等核心信息。

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。
    使用配置中的mdt_report_indicators来确定需要在MDT报告中展示的检验指标。

    **增量更新模式：**
    如果提供了现有MDT报告数据，你需要：
    1. 保留现有报告中的历史信息，不要删除已有的检查结果和病史记录
    2. 将新的检查结果和诊断信息整合到现有报告中
    3. 更新实验室检查表格，添加新的检查数据，保持时间顺序
    4. 如果患者基本信息有更新，以最新信息为准
    5. 确保报告的完整性和时间连续性

    输入：
    [系统日期]: {current_date}
    [患者结构化数据]: {patient_structured_data}
    [患者文本]: {patient_content}
    [现有MDT报告]（如有）: {existing_mdt_report}

    报告要求：
    1. 标题：患者信息概览
    2. 一级标题：XXX（患者姓名）简要病史及辅助检查
       - 按时间顺序列出关键检查和诊断信息
       - 格式：日期 + 检查类型 + 关键结果描述
    3. 一级标题：既往史
       - 列出患者的既往病史、手术史、过敏史等
    4. 一级标题：实验室检查
       - 按开单时间分组的表格形式
       - **重要**：使用疾病配置中的mdt_report_indicators字段，只提取配置中列出的检验指标
       - 表头：检查项目、开单时间、报告时间、项目名称、结果、参考值(正常区间)、异常提示(阴性、阳性、偏高、偏低)
    5. 一级标题：影像学检查
       - 列出患者的影像学检查结果，以表格形式呈现
       - 格式： 检查项目 + 报告关键结果原文 + 日期
       - 表头：检查项目、报告结果、检查时间

    格式化要求：
    - 使用简体中文输出
    - 确保信息准确、客观
    - 按时间顺序排列

  expected_output: >
    返回结构化的MDT报告数据，格式为JSON数组，每个元素包含type和content字段：
    {{"mdt_simple_report": 
    [
      {{ "type": "title", "content": "患者信息概览" }},
      {{ "type": "heading", "level": 1, "content": "XXX简要病史及辅助检查" }},
      {{ "type": "paragraph", "content": "病史和检查内容..." }},
      {{ "type": "heading", "level": 1, "content": "既往史" }},
      {{ "type": "paragraph", "content": "既往史内容..." }},
      {{ "type": "heading", "level": 1, "content": "实验室检查" }},
      {{ "type": "table", "headers": ["检查项目", "开单时间", "报告时间", "项目名称", "结果", "参考值(正常区间)", "异常提示"], "rows": [["血常规", "2025-01-01", "2025-01-01", "白细胞", "5.2", "3.5-9.5", "正常"]] }}
      {{ "type": "heading", "level": 1, "content": "影像学检查" }},
      {{ "type": "table", "headers": ["检查项目", "报告结果", "检查时间"], "rows": [["上腹部CT", "结果原文", "2025-01-01"]] }}
    ]}}
  agent: mdt_report_generator 