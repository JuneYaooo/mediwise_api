get_disease_config_task:
  description: >
    根据患者信息识别疾病并获取相应的看板配置信息。支持识别多个疾病（主要疾病通常2-3种）。

    输入信息:
    患者描述: {patient_info}

    工作流程(必须严格按照以下步骤执行):

    步骤1: 获取所有可用疾病
    - 调用"获取疾病列表工具"获取系统中所有可用的疾病列表
    - 不需要任何参数,直接调用即可

    步骤2: 识别患者的所有疾病
    - 仔细分析输入的患者信息,从步骤1获取的疾病列表中,判断患者可能患有哪些疾病
    - 考虑疾病的同义词、简称、别名等(如"肝癌"、"肝细胞癌"、"HCC"等)
    - 通常一个患者可能有2-3种主要疾病,识别所有相关的疾病
    - 按疾病的重要性排序(主要疾病在前)

    步骤3: 批量查询疾病配置
    - 调用"查询疾病配置工具",输入识别到的所有疾病名称(用逗号分隔)
    - 例如: '肝癌,淋巴瘤' 或 '肝癌'
    - 同时将患者信息作为patient_input参数传入

    步骤4: 分析和输出结果
    - 提取并返回所有疾病的配置信息列表,每个疾病包括:
      * disease_name: 疾病名称
      * dashboard_description: 看板说明（包含数据提取要求、关键指标、时间轴要求等详细说明）

    注意事项:
    - 如果无法明确识别任何疾病,返回通用配置
    - 如果患者信息不足,提示需要补充更多信息
    - 如果只识别到一个疾病也没问题,返回单个疾病的配置列表
    - 如果识别到多个疾病,返回所有疾病的配置列表

  expected_output: >
    成功时,返回JSON格式的疾病配置列表:
    {{
      "status": "success",
      "count": 2,
      "primary_diseases": ["肝癌", "淋巴瘤"],
      "configs": [
        {{
          "disease_name": "肝癌",
          "dashboard_description": "看板配置说明文本..."
        }},
        {{
          "disease_name": "淋巴瘤",
          "dashboard_description": "看板配置说明文本..."
        }}
      ]
    }}

    如果识别失败,返回:
    {{
      "status": "not_found",
      "message": "无法识别疾病,请补充更多信息",
      "configs": []
    }}

    如果部分疾病未找到配置:
    {{
      "status": "success",
      "count": 1,
      "warning": "部分疾病未找到配置: 某疾病名",
      "not_found_diseases": ["某疾病名"],
      "configs": [...]
    }}

  agent: disease_config_agent

preprocess_files_task:
  description: >
    从用户上传的部分文件中提取与患者相关的临床和医疗信息，将文件内容精简为能够被模型高效处理的格式。

    请注意：
    1. 每个文件可能包含大量内容，你需要专注于提取与患者病情、诊断、治疗和医疗历史相关的客观信息
    2. 对于医疗检验报告，提取所有检验值和参考范围，尤其是超出参考范围的检验值
    3. 对于病历，提取诊断、主诉、现病史、既往史等客观记录
    4. 对于医学文献或指南，只提取与患者当前情况直接相关的客观内容
    5. 删除重复信息，保留最新的客观信息
    6. 若文件名中包含"(Part X/Y)"格式，表示这是大文件的一个分块。处理大文件分块时：
       - 关注这个分块中的客观信息，但不要重复之前已经提取过的基本信息
       - 对于检验报告分块，提取所有检验值
       - 保持信息的上下文完整性，确保能理解片段的意义
    7. **医院名称规范化要求**：
       - 原始材料中可能出现"本院"、"我院"、"该院"等指代性词汇
       - 必须从文件头部、落款、公章、文件元数据等位置识别出具体的医院名称
       - 将所有"本院"、"我院"等词汇替换为具体医院名称（如"浙江大学医学院附属第一医院"）
       - 如果无法确定具体医院名称，根据上下文决定：可以删除医院表述，或使用"就诊医院"等中性词汇，或直接省略
       - 核心原则：严禁在输出中保留"本院"、"我院"等指代性词汇
    
    请处理以下批次中的文件，结合原始患者描述：
    [系统日期]: {current_date}
    [患者描述]: {patient_info}
    
    
    待处理文件（本批次）：
    {files_batch}
    
  expected_output: >
    返回提取并精简后的患者信息文本（不要使用JSON格式），仅包含与临床诊断 检查检验结果 和治疗直接相关的客观信息，过滤掉无效模板和无关的患者信息，病理与影像等要尽量保持原文重要叙述，需要包含日期，比如下面这些信息(有的就提，没有的或者不相关的就算了)：
    - 基本信息（年龄、性别、主诉）
    - 现病史（按时间顺序）
    - 既往史
    - 检查检验结果（标注超出参考范围的值）
    - 诊断及处理
    - 其他客观信息

  agent: file_preprocessor
  
process_patient_data_task:
  description: >
    从输入的患者临床描述中提取所有相关客观信息，构建时间轴或者更新当前患者时间轴，并按类别整理详细信息。确保使用统一、标准化的字段格式，便于前端展示。时间尽量转换为标准的yyyy-MM-dd格式，若患者当前最近一次询问或者信息没有提供具体时间，则使用当前日期作为默认值。如果是病史描述，或者历史的医疗资料，肯定非当天的，或者非当前的疾病情况，且没有具体时间的，用"时间不详"作为默认值：

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。
    配置格式为: {{"status": "success", "count": N, "configs": [...]}}
    每个config包含: disease_name（疾病名称）, dashboard_description（看板说明，包含数据提取要求、关键指标等详细说明）。

    **重要**：请仔细阅读dashboard_description中的说明，它包含了该疾病的：
    - 关键指标提取要求
    - 时间轴构建要求
    - 重点标注规则
    - 病历事件回顾维度
    - 特殊字段提取要求（如手术医院、主刀医生等）

    根据看板说明中的要求，调整数据提取的重点和格式。如果患者有多个疾病，需要综合所有疾病的配置进行数据提取。

    **增量更新模式：**
    如果提供了现有时间轴数据，你需要：
    1. 保留现有时间轴中的所有历史数据，不要删除或修改已有的时间轴条目
    2. 将新的患者信息与现有时间轴合并，添加新的时间轴条目或更新相关条目
    3. 确保时间轴按时间顺序排列，新信息应插入到正确的时间位置
    4. 如果新信息与现有时间轴中的某个时间点相关，应更新该条目而不是创建重复条目
    5. 保持患者基本信息的一致性，如果有冲突以最新信息为准

    [系统日期]: {current_date}
    [患者描述]: {patient_info}
    [当前患者时间轴]: {patient_timeline}
    [现有时间轴数据]（如有）: {existing_timeline}

    **重要提示：**
    1. 患者描述中可能包含"会诊目的："或"就诊目的："标签，请务必提取其后的内容并填充到patient_info.basic.purpose字段中。如果没有明确标注，请从患者描述中识别并提取就诊目的相关信息。
    2. **医院名称规范化**：原始材料中可能出现"本院"、"我院"、"该院"等指代性词汇。必须识别并替换为具体医院名称（从文件头部、落款、元数据等位置提取）。如无法确定具体名称，根据上下文决定是否需要体现医院信息：可以省略医院表述，或使用"就诊医院"等中性词汇。核心原则：严禁在输出中保留"本院"、"我院"等指代性词汇。

    格式化要求：
    1.核心要求：构建时间轴时，请严格遵循“临床事件/阶段”为最高层级的原则。一次门诊、一次住院、一个治疗周期应作为一个独立的时间轴条目（timeline entry）。禁止将同一次临床事件中的不同检查类型（如检验、影像）拆分成多个时间轴条目。比如初诊初治、xx手术治疗、
      正确做法：将为同一临床目的、在相近时间内完成的不同类型的诊疗活动，归并到同一个时间轴条目下，并使用该临床事件（如“门诊复查”）作为标题title。条目内部再使用不同的data_blocks（如“检验”、“检查”）来组织不同类型的数据。
      举例说明：
        错误示范：
        timeline[0]: {{ title: "门诊复查 - 影像学评估", ... }}
        timeline[1]: {{ title: "门诊复查 - 肿瘤标志物监测", ... }}
        正确示范：
        timeline[0]: {{ title: "2025年4月门诊复查", type: "visit", ... }}
        data_blocks[0]: {{ block_type: "检查", block_title: "上腹CT增强", ... }}
        data_blocks[1]: {{ block_type: "检验", block_title: "肿瘤标志物检测", ... }} (如果这次复查也抽血了)
      时间相近性原则：如果多项检查、检验或处置发生在同一周内，且属于同一临床决策流程（如一次住院期间的术前检查、或一次门诊复查的全面评估），强烈建议将它们归入同一个时间轴条目。仅当时间间隔较长（如超过1-2周）且临床目的明显不同时，才考虑拆分。
    2. 在每个临床阶段的条目内，将同类信息（如所有"检验"结果，所有"影像"报告）合并到单一的data_block中，不要分散。例如，一次"术前准备"阶段的所有化验都应放在一个"检验"类型的data_block里。
    3. 不同类型的数据应放入不同的data_block，例如"检验"和"检查"分别放入不同的data_block。
    4. 如果当前患者时间轴中没有包含当前的医疗事件，则需要将当前的医疗事件添加到当前患者时间轴中。
    5. 对于影像病理报告要尽量保持原文重要叙述包括大小之类的，对于检验要提取所有检验值，并标注超出参考范围的值。
    6. **重要**：对于检验指标的提取，使用疾病识别工具获取的配置中的lab_test_indicators字段，只提取配置中列出的检验指标。如果未识别到特定疾病或配置为空，则提取所有检验指标。
    7. **location字段规范**：如果原始材料中有具体的医院名称和科室信息，提取并填入（如"浙江大学医学院附属第一医院 肝胆胰外科"）。严禁使用"本院"、"我院"等指代性词汇。如果原始材料中只有"本院"等表述，需要从文件头部、落款等位置识别真实医院名称进行替换。如无法确定或上下文不需要体现医院信息，则留空。
    
    
  expected_output: >
    返回JSON格式的结构化患者数据，包含患者基本信息和时间轴，使用标准化通用字段。
    **重要：所有输出必须使用简体中文，绝对不允许输出Unicode编码符号（如\\u4e2d\\u6587、\\u809d\\u810f等）。必须直接输出可读的中文字符（如"中文"、"肝脏"等）。**
    
    返回格式：
    {{
      "patient_info": {{
        "basic": {{
          "name": "患者姓名(如有,不要出现多个)",
          "age": "年龄",
          "gender": "性别",
          "purpose": "就诊目的",
          "main_complaint": "主诉" # 这个是最近一次患者的主诉,也就是日期最新的一次
        }},
        "medical_history": [
          {{
            "type": "疾病史/手术史/过敏史/家族史/社会史/药物史/其他",
            "name": "具体名称",
            "time": "yyyy-MM-dd格式或者yyyy-MM格式或者yyyy格式（若没有明确日期，推算或者使用时间不详，或者描述也可以）",
            "details": "详细描述"
          }}
        ]
      }},
      "timeline": [
        {{
          "id": "t1",
          "time_period": {{
            "start": "yyyy-MM-dd格式开始日期（若没有明确日期，使用当前日期）",
            "end": "yyyy-MM-dd格式结束日期（若为进行中事件，可为空）"
          }},
          "title": "标题（如初诊/复诊/住院/门诊/术后/术中/术前/化疗/放疗等）",  #title应简洁地概括临床事件的性质，例如"初诊"、"第X次化疗"、"术后第Y天复查"、"YYYY年MM月门诊随访"等。避免在title中直接使用数据块类型（如"检验"、"影像"）
          "type": "visit/exam/surgery/medication/other",
          "location": "医疗机构/科室（如有具体医院名称则填入，如'浙江大学医学院附属第一医院 肝胆胰外科'。严禁使用'本院'、'我院'等指代性词汇。如无具体信息或不需要体现则留空）",
          "summary": "概要描述，格式如疾病状态/手术状态+关键处置/治疗+关键指标+疗效（如有）",
          "key_indicators": "与疾病关键决策点有关的，使用疾病配置中的key_decision_indicators作为参考，提取相关信息，用markdown格式返回。
          "data_blocks": [
            {{
              "block_type": "现病史/诊断/检验/检查/病理/影像/用药/处置/手术/随访/医嘱/其他",
              "block_title": "数据块标题", # block_title用于描述数据块的内容，例如“血常规”、“肝功能”、“上腹部MRI”、“实验室检查”等，对于一次实验室检查归纳到一个数据块里。
              "items": [
                {{
                  "name": "项目名称",
                  "value": "检验关键项目值的拼接或者结果或者病理或者影像的结论", //要点
                  "status": "normal/abnormal/critical/pending", // 仅基于参考范围的客观判断
                  "time": "yyyy-MM-dd格式（若为具体时间点，如同一天内的不同时间，可以是yyyy-MM-dd HH:mm）",
                  "details": "详细描述", 病理与影像需要保持原文，不要精简掉重要信息,不要总结。
                  "file_uuid": "来源文件的UUID（如果基于某个源文件提取，否则为空）",
                  "metadata": {{ 
                    // 可扩展字段，根据block_type不同而包含不同的附加信息
                    // 例如检验可能包含具体检验值，参考范围，用药可能包含剂量频次，病理可能包含病理类型，病理结果详细描述，影像可能包含影像报告详细描述等
                  }},
                  "need_check": true/false // 看起来内容不合理（可能是原始文件在文本化提取的时候发生错误），建议人工检查去查看原始文件
                }}
              ]
            }}
          ]
        }}
      ],
      "summary": {{
        "diagnoses": ["诊断1", "诊断2"], // 记录所有医生确诊的诊断，未确诊的诊断不要记录，不要擅自推断
        "treatments": ["治疗1", "治疗2"], // 记录所有已实施的治疗
        "scheduled_events": [
          {{
            "event_type": "预约/检查/手术/其他",
            "scheduled_time": "yyyy-MM-dd格式预定日期",
            "description": "事件描述"
          }}
        ]
      }},
    }}

  agent: patient_data_processor

generate_timeline_summary_task:
  description: >
    从输入的患者临床描述中提取关键信息，生成简化的时间轴摘要。只输出时间轴的核心信息（id, 时间、标题、摘要、关键指标），不包含详细的data_blocks。

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。
    配置格式为: {{"status": "success", "count": N, "configs": [...]}}
    每个config包含: disease_name（疾病名称）, dashboard_description（看板说明）。

    **重要**：请仔细阅读dashboard_description中的说明，特别关注：
    - 时间轴构建要求：如何组织临床事件
    - 关键指标提取要求：哪些指标需要在摘要中显示

    **增量更新模式：**
    如果提供了现有时间轴摘要数据，你需要：
    1. 保留现有时间轴中的所有历史条目
    2. 将新的事件添加到时间轴中，按时间顺序排列
    3. 如果新信息与现有条目相关，更新该条目的摘要信息
    4. 保持患者基本信息的一致性

    [系统日期]: {current_date}
    [患者描述]: {patient_info}
    [现有时间轴摘要]（如有）: {existing_timeline_summary}

    **重要提示：**
    1. 患者描述中可能包含"会诊目的："或"就诊目的："标签，请务必提取其后的内容并填充到patient_info.basic.purpose字段中。如果没有明确标注，请从患者描述中识别并提取就诊目的相关信息。
    2. **医院名称规范化**：原始材料中可能出现"本院"、"我院"、"该院"等指代性词汇。必须识别并替换为具体医院名称（从文件头部、落款、元数据等位置提取）。如无法确定具体名称，根据上下文决定是否需要体现医院信息：可以省略医院表述，或使用"就诊医院"等中性词汇。核心原则：严禁在输出中保留"本院"、"我院"等指代性词汇。

    格式化要求：
    1. 核心要求：构建时间轴时，请严格遵循"临床事件/阶段"为最高层级的原则。一次门诊、一次住院、一个治疗周期应作为一个独立的时间轴条目。
    2. 每个条目只包含摘要信息，不包含详细的data_blocks
    3. 为每个条目生成唯一的id（格式：t1, t2, t3...）
    4. 在summary字段中简要描述该时间点的关键事件（不超过200字）
    5. 在key_indicators字段中列出最重要的指标（使用markdown格式，异常值标红）
    6. 标记has_details为true（表示该条目有详细数据需要后续生成）
    7. **location字段规范**：如果原始材料中有具体的医院名称和科室信息，提取并填入（如"浙江大学医学院附属第一医院 肝胆胰外科"）。严禁使用"本院"、"我院"等指代性词汇。如果原始材料中只有"本院"等表述，需要从文件头部、落款等位置识别真实医院名称进行替换。如无法确定或上下文不需要体现医院信息，则留空。

  expected_output: >
    返回JSON格式的简化时间轴，包含患者基本信息和时间轴摘要：
    **重要：所有输出必须使用简体中文，绝对不允许输出Unicode编码符号。**

    {{
      "patient_info": {{
        "basic": {{
          "name": "患者姓名",
          "age": "年龄",
          "gender": "性别",
          "purpose": "就诊目的",
          "main_complaint": "主诉"
        }},
        "medical_history": [
          {{
            "type": "疾病史/手术史/过敏史/家族史/社会史/药物史/其他",
            "name": "具体名称",
            "time": "yyyy-MM-dd格式",
            "details": "详细描述"
          }}
        ]
      }},
      "timeline": [
        {{
          "id": "t1",
          "time_period": {{
            "start": "yyyy-MM-dd",
            "end": "yyyy-MM-dd或空"
          }},
          "title": "标题（如初诊/复诊/住院/门诊/术后等）",
          "type": "visit/exam/surgery/medication/other",
          "location": "医疗机构/科室（如有具体医院名称则填入，如'浙江大学医学院附属第一医院 肝胆胰外科'。严禁使用'本院'、'我院'等指代性词汇。如无具体信息或不需要体现则留空）",
          "summary": "概要描述（不超过200字），包括疾病状态、关键处置、关键指标、疗效等",
          "key_indicators": "关键指标（markdown格式，异常值用<span style=\"color:#d0021b\">值↑</span>标红）",
          "has_details": true,
          "detail_blocks_info": "简要说明包含哪些类型的数据块（如：检验、检查、病理、影像、用药等）"
        }}
      ]
    }}

  agent: timeline_summary_generator

generate_timeline_details_task:
  description: >
    为指定的时间轴条目生成详细的data_blocks数据。基于患者信息和时间轴摘要，提取该时间点的所有详细检验、检查、病理、影像等数据。

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。

    **重要**：请仔细阅读dashboard_description中的说明，特别关注：
    - 关键指标提取要求：需要提取哪些检验指标
    - 重点标注规则：哪些值需要标注为异常
    - 特殊字段提取要求：如手术医院、主刀医生等

    **任务目标：**
    为指定的时间轴条目（通过target_timeline_id标识）生成完整的data_blocks数据。

    **输入说明：**
    [系统日期]: {current_date}
    [患者描述]: {patient_info}  # 包含患者的所有原始信息，包括检验、检查、病理、影像等详细数据
    [时间轴摘要]: {timeline_summary}  # 包含所有时间轴条目的摘要信息（id, time_period, title, type, location, summary等）
    [目标时间轴ID]: {target_timeline_id}  # 需要生成详细数据的时间轴条目ID（如"t1", "t2"等）

    **工作流程：**
    1. 从timeline_summary中找到target_timeline_id对应的时间轴条目
    2. 查看该条目的time_period（时间范围）、title（标题）、type（类型）、summary（概要）
    3. **关键步骤**：根据时间范围，从patient_info中搜索该时间段内的所有原始数据：
       - 搜索该时间段的检验报告（血常规、肝功能、肾功能、肿瘤标志物等）
       - 搜索该时间段的影像检查（CT、MRI、超声、X光等）
       - 搜索该时间段的病理报告
       - 搜索该时间段的用药记录
       - 搜索该时间段的手术记录
    4. 将提取的原始数据按类型组织成data_blocks（检验、检查、病理、影像、用药等）

    **重要提示：**
    - **不要只看summary字段**：summary只是概要，你需要从patient_info中提取完整的原始数据
    - **提取所有检验值**：如果patient_info中有该时间段的检验报告，必须提取所有检验项目和数值
    - **保留影像病理原文**：影像和病理报告要保留原文的重要描述（大小、位置、性质等）
    - **如果确实没有详细数据**：只有当patient_info中真的没有该时间段的详细数据时，才返回空的data_blocks
    - **不要臆造数据**：只提取patient_info中明确存在的信息

    **示例说明：**
    假设target_timeline_id="t1"，对应的时间轴条目是：
    - time_period: {{"start": "2024-03-15", "end": "2024-03-20"}}
    - title: "初诊初治"
    - summary: "确诊肝癌，AFP升高，CT显示肝右叶占位"

    你需要做的是：
    1. 在patient_info中搜索2024-03-15到2024-03-20期间的所有数据
    2. 如果找到检验报告，提取所有检验项目（不只是AFP，还有其他所有项目）
    3. 如果找到CT报告，提取完整的影像描述（不只是"肝右叶占位"，还要包括大小、密度、增强特点等）
    4. 组织成data_blocks返回

    格式化要求：
    1. 只生成指定target_timeline_id的详细数据
    2. 将同类信息合并到单一的data_block中（如所有检验结果放在一个"检验"类型的data_block）
    3. 不同类型的数据放入不同的data_block（检验、检查、病理、影像、用药等）
    4. 对于检验指标，提取所有检验值，并标注超出参考范围的值
    5. 对于影像病理报告，保持原文重要叙述（包括大小、位置等）
    6. 每个item需要包含file_uuid（来源文件标识，如果patient_info中有的话）

  expected_output: >
    返回JSON格式的详细数据块：
    **重要：所有输出必须使用简体中文，不能包含Unicode编码符号。**

    {{
      "timeline_id": "t1",
      "data_blocks": [
        {{
          "block_type": "现病史/诊断/检验/检查/病理/影像/用药/处置/手术/随访/医嘱/其他",
          "block_title": "数据块标题（如：血常规、肝功能、上腹部CT等）",
          "items": [
            {{
              "name": "项目名称",
              "value": "检验关键项目值的拼接或者结果或者病理或者影像的结论",
              "status": "normal/abnormal/critical/pending",
              "time": "yyyy-MM-dd格式（若为具体时间点，如同一天内的不同时间，可以是yyyy-MM-dd HH:mm）",
              "details": "详细描述（病理与影像需要保持原文，不要精简掉重要信息，不要总结）",
              "file_uuid": "来源文件的UUID（如果基于某个源文件提取，否则为空）",
              "reference": "参考范围（仅检验项目需要）",
              "unit": "单位（仅检验项目需要）"
            }}
          ]
        }}
      ]
    }}

    **注意**：
    - 如果patient_info中没有该时间点的详细数据，返回空的data_blocks数组：{{"timeline_id": "t1", "data_blocks": []}}
    - 不要返回null或省略data_blocks字段，必须返回完整的JSON结构
    - **data_blocks为空应该是罕见情况**，大多数时候应该能从patient_info中提取到详细数据
    - 对于检验项目，value字段填写检验值，reference和unit字段必填
    - 对于病理和影像，value字段填写结论，details字段填写完整的原文描述（不要精简）
    - 对于其他类型，根据实际情况填写value和details字段

  agent: timeline_details_generator

extract_patient_journey_task:
  description: >
    基于输入生成"患者时间旅程"数据，专注于提取患者主要事件的时间轴。

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。
    每个config包含: disease_name（疾病名称）, dashboard_description（看板说明）。

    **重要**：请仔细阅读dashboard_description中的说明，特别关注：
    - 重点标注规则：哪些内容需要在患者旅程中标红显示
    - 特殊字段提取：如手术医院、主刀医生、检查医院等

    根据看板说明中的要求来提取和标注关键信息。

    **任务目标：**
    提取患者主要事件的时间轴（简明版）：按日期聚合一个时间点对应一条文本，文本不超过100字；将事件类型标注为"主疾病"或"共病"；文本中的关键实体/治疗/诊断/病理/影像要点需使用**加粗**，重要指标或者异常值需标红（参考看板说明中的重点标注规则，使用<span style="color:#d0021b">值</span>）。主要事件包括但不限于：重要检验/检查/病理结果及相应诊断、手术/放疗/化疗/介入/免疫/靶向等治疗、疾病进展或复发、不良反应、入出院节点、重要门急诊随访等。对于手术事件，如果能获知主刀医生的信息，也需要把主刀医生提取出来，放在专门的字段里。对于胃肠镜等大型检查事件，如果能获知检查所在医院的信息，也需要提取出来，放在专门的字段里。

    **增量更新模式：**
    如果提供了现有患者时间旅程数据，你需要：
    1. 保留现有时间旅程中的所有历史事件，不要删除已有的事件
    2. 将新的事件与现有时间旅程合并，按时间顺序插入新事件
    3. 如果发现相同日期的事件，应合并而不是重复
    4. 确保时间旅程的连续性和完整性

    输入：
    [系统日期]: {current_date}
    [患者文本]: {patient_content}
    [患者结构化数据]: {full_structure_data}
    [现有患者时间旅程]: {existing_timeline_journey}

    规则：
    - 仅基于提供的信息做客观提取，不得臆测。
    - 同日多事件合并为一条简洁文本（<=100字），优先描述"诊断/治疗/病理/影像/显著异常检验值"。
    - 异常值（高/低/阳性/超参考）需在文本内标红（<span style="color:#d0021b">...</span>），并可在括号里注明参考范围或"↑/↓/阳性"。
    - 关键词（如疾病名、治疗方式、关键结论）需**加粗**。
    - 事件类型仅二选一：主疾病/共病；若与主诊断直接相关则判为主疾病，否则为共病。
    - 日期尽量标准化为yyyy-MM-dd；当仅有月份或相对时间时，尽量推断具体日期，无法确定则使用当前日期。
    - 每个事件需提取来源文件UUID：从full_structure_data的timeline中找到对应时间点的data_blocks.items，提取其file_uuid字段，以{{"file_uuid": "xxx"}}格式放入sources数组。如果一个事件涉及多个来源文件，将所有相关来源放入数组。如果无法确定来源或原始数据中没有file_uuid，则sources为空数组。
    - **医院名称规范化**：文本中如出现"本院"、"我院"、"该院"等词汇，必须替换为具体医院名称（从原始材料中识别）。如无法确定具体名称，根据上下文决定是否需要体现医院信息：可以省略医院表述，或使用"就诊医院"等中性词汇。核心原则：严禁在text字段中保留"本院"、"我院"等指代性词汇。

  expected_output: >
    返回JSON数组格式的患者时间旅程：
    注意：所有输出必须使用简体中文，不能包含Unicode编码符号（如\\u4e2d\\u6587等）。如果模型输出包含Unicode编码，必须将其解码为正常的中文字符。

    [
      {{
        "date": "yyyy-MM-dd",
        "type": "主疾病|共病",
        "text": "不超过100字；**关键词加粗**；异常值用<span style=\"color:#d0021b\">值</span>标红",
        "chief_surgeon": "如果是手术事件，且有主刀医生信息，才需要提取主刀医生的名字，否则为空",
        "examination_hospital": "如果是胃肠镜等大型检查事件，且有检查所在医院信息，才需要提取医院名称，否则为空",
        "sources": [{{"file_uuid": "来源文件UUID"}}]
      }}
    ]

  agent: patient_journey_extractor

generate_patient_journey_summary_task:
  description: >
    从输入的患者数据中提取患者时间旅程的摘要信息。输出事件的核心信息：日期、事件类型、事件描述。

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。

    **增量更新模式：**
    如果提供了现有患者时间旅程摘要数据，你需要：
    1. 保留现有时间旅程中的所有历史事件
    2. 将新的事件添加到时间旅程中，按时间顺序排列
    3. 如果发现相同日期的事件，应合并而不是重复
    4. 确保时间旅程的连续性和完整性

    输入：
    [系统日期]: {current_date}
    [患者文本]: {patient_content}
    [患者结构化数据]: {full_structure_data}
    [现有患者时间旅程摘要]（如有）: {existing_journey_summary}

    **【重要】摘要阶段的核心任务：精准筛选主要事件**

    这是分层提取的第一步，也是最关键的一步。你需要在这一步就精准地识别出哪些是真正的主要事件，做到：
    - ✅ 不遗漏重要事件
    - ✅ 不多提取次要事件
    - ✅ 精准判断每个事件的临床意义

    **什么是"主要事件"？**
    主要事件必须同时满足两个条件：
    1. 对患者诊疗过程有**独立的临床意义**
    2. 是病程中的**关键节点**，而非辅助性或常规性的检查

    主要事件包括：
    - **诊断节点**：初诊发现、确诊检查、病情变化（复发、转移、进展）
    - **治疗节点**：手术、化疗、放疗、介入、靶向、免疫等重要治疗
    - **关键评估**：有重要发现的影像学检查（CT、MRI、PET-CT）、病理诊断、肿瘤标志物显著异常
    - **决策节点**：MDT会诊、治疗方案调整
    - **重要节点**：入院（如果伴随重要诊断）、出院（如果有重要诊断结论）

    **精准判断标准（根据临床意义）：**

    1. **必须作为独立事件**：
       - 首次发现病灶的检查（如初诊CT）
       - 确诊的关键检查（如病理、特征性MRI）
       - 重要的诊断依据（如肿瘤标志物首次显著升高）
       - 所有治疗节点（手术、每次化疗/放疗周期、介入治疗）
       - 发现病情变化的检查（如发现复发、转移的影像学检查）
       - MDT会诊、治疗方案调整等决策点
       - 疗效评估的关键检查（如术后复查、治疗后评估）

       **参考示例**（第一版的输出）：
       - 2025-02-26: 入院，CT发现肝右叶异常密度灶 → 独立事件（初次发现）
       - 2025-02-27: AFP 23483.28ng/ml↑，PIVKA-II 6571.00ng/ml↑ → 独立事件（重要诊断依据）
       - 2025-02-28: MRI示肝S7、8病灶，考虑肝细胞癌 → 独立事件（确诊检查）
       - 2025-03-04: MDT会诊，建议外科手术切除 → 独立事件（治疗决策）
       - 2025-03-10: 腹腔镜肝部分切除+膈肌修补术 → 独立事件（手术治疗）
       - 2025-03-18: 复查CT示术后改变，发现T12椎体压缩骨折 → 独立事件（术后评估）
       - 2025-04-01: 出院，诊断明确 → 独立事件（阶段性节点）
       - 2025-08-05: 再次入院，CT示双肺多发结节，考虑转移瘤 → 独立事件（病情进展）
       - 2025-08-06: 彩超示右肝内混合回声，心脏彩超 → 独立事件（重要检查）
       - 2025-08-11: 肝包膜肿瘤穿刺活检+微波消融术 → 独立事件（治疗）
       - 2025-08-15: 出院 → 独立事件（阶段性节点）

    2. **不应作为独立事件**（合并或省略）：
       - 辅助性的常规检查（如术前血常规、凝血功能、心电图）
       - 无重要发现的常规复查
       - 与主要事件在同一天的辅助性检查（合并到主要事件中）

    3. **判断口诀**：
       问自己：如果在病历摘要中省略这个事件，会不会影响对患者病程的理解？
       - 如果答案是"会影响" → 必须作为独立事件
       - 如果答案是"不影响" → 合并或省略

    4. **事件总数**：根据患者实际病程确定，不设数量限制。
       - 病程短、治疗简单的患者可能只有5-8个主要事件
       - 病程长、多次治疗的患者可能有20-30个甚至更多主要事件
       - 关键是每个事件都必须有独立的临床意义，不要为了凑数而多提取，也不要为了控制数量而遗漏重要事件
       - 以第一版的输出为参考标准（理解什么样的事件应该提取），但不是说数量要一样

    格式化要求：
    1. 根据上述"主要事件提取原则"，识别所有有独立临床意义的事件
    2. 为每个事件生成唯一的id（格式：j1, j2, j3...）
    3. 识别事件类型（主疾病/共病）
    4. **重要**：为每个事件生成一段简要的事件描述（event_description），说明这是什么事件（如"入院CT发现肝右叶占位"、"AFP等肿瘤标志物检查"、"MRI确诊肝细胞癌"、"MDT会诊决定手术"、"肝癌根治性切除术"、"术后复查CT"等）
    5. 事件描述应简洁明确，体现该事件的临床意义
    6. 不需要提取详细的文本、特殊字段、来源文件等信息，这些将在明细生成阶段提取

  expected_output: >
    返回JSON数组格式的患者时间旅程摘要：
    **重要：所有输出必须使用简体中文，绝对不允许输出Unicode编码符号。**

    [
      {{
        "id": "j1",
        "date": "yyyy-MM-dd",
        "type": "主疾病|共病",
        "event_description": "简要的事件描述，说明这是什么事件（如：肝癌根治性切除术、第3次TACE治疗、上腹部CT复查等）"
      }}
    ]

  agent: patient_journey_summary_generator

generate_patient_journey_details_task:
  description: >
    为指定的患者时间旅程事件生成完整的详细信息。基于原始患者数据、时间旅程摘要（特别是事件描述），提取该事件的所有详细信息。

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。

    **重要**：请仔细阅读dashboard_description中的说明，特别关注：
    - 重点标注规则：哪些内容需要在患者旅程中标红显示
    - 特殊字段提取：如手术医院、主刀医生、检查医院等

    **任务目标：**
    为指定的事件ID列表生成完整的详细信息，包括：
    1. 详细文本描述（不超过100字，关键词**加粗**，异常值标红）
    2. 特殊字段（如手术医生、检查医院等）
    3. 来源文件UUID

    **重要提示：**
    1. 时间旅程摘要中的 event_description 字段说明了这是什么事件（如"肝癌根治性切除术"、"第3次TACE治疗"、"上腹部CT复查"等）
    2. 你需要根据这个事件描述，从原始患者数据（patient_content）和结构化数据（full_structure_data）中找到对应的详细信息
    3. 生成的详细文本不需要完全照搬事件描述，而是要基于事件描述去原始数据中提取更详细、更丰富的信息
    4. 例如：如果事件描述是"肝癌根治性切除术"，你需要从原始数据中找到这次手术的详细信息（手术时间、主刀医生、手术方式、术中情况、术后病理等），然后生成一段不超过100字的高信息密度文本

    输入：
    [系统日期]: {current_date}
    [患者原始文本]: {patient_content}
    [患者结构化数据]: {full_structure_data}
    [时间旅程摘要]: {journey_summary}  # 包含 id、date、type、event_description
    [目标事件ID列表]: {target_event_ids}

    格式化要求：
    1. 只生成指定event_ids的详细信息
    2. 根据摘要中的event_description，从原始数据中提取对应事件的详细信息
    3. **text字段格式要求（重要）**：
       - 简洁但包含必要信息，不超过100字
       - 使用专业的医学术语和标准缩写（如CT、MRI、AFP、PIVKA-II等）
       - 采用客观、精炼的叙述方式：
         * 入院："因...入院"
         * 检查结果："CT示..."、"MRI示..."、"彩超示..."
         * 手术："行...术"、"全麻下行..."
         * 诊断："诊断为..."、"考虑..."
         * 会诊："MDT会诊结论:..."
         * 出院："办理出院。诊断为..."
       - 优先包含：诊断、关键检查结果（含大小、位置等）、异常指标、治疗方式
       - 关键词（疾病名、治疗方式、关键结论）需**加粗**
       - 异常值需标红：<span style="color:#d0021b">值↑/↓</span>，并注明单位
       - **医院名称规范化**：如文本中出现"本院"、"我院"、"该院"等词汇，必须替换为具体医院名称（从原始材料中识别）。如无法确定具体名称，根据上下文决定是否需要体现医院信息：可以省略医院表述，或使用"就诊医院"等中性词汇。核心原则：严禁在text字段中保留"本院"、"我院"等指代性词汇。

       **参考示例**：
       - "因**乙肝肝硬化**、**肝恶性肿瘤?**入院。CT示肝右叶异常密度灶(16*18mm),考虑**恶性**。尿比重 <span style=\"color:#d0021b\">1.040↑</span>,尿隐血 <span style=\"color:#d0021b\">1+↑</span>。"
       - "AFP <span style=\"color:#d0021b\">23483.28ng/ml↑</span>,PIVKA-II <span style=\"color:#d0021b\">6571.00ng/ml↑</span>,HBsAg <span style=\"color:#d0021b\">336.950IU/ml↑</span>。肺部CT示**双肺小结节**(Lung-RADS 2级)。"
       - "全麻下行**腹腔镜探查+肝部分切除+膈肌修补术**。术后CRP <span style=\"color:#d0021b\">38.00↑</span>,ALT <span style=\"color:#d0021b\">237.70↑</span>,Alb <span style=\"color:#d0021b\">33.80↓</span>。"

    4. 提取特殊字段：
       - 如果是手术事件，提取主刀医生信息（chief_surgeon字段）
       - 如果是胃肠镜等大型检查事件，提取检查医院信息（examination_hospital字段）
    5. 提取来源文件UUID：从full_structure_data的timeline中找到对应时间点的data_blocks.items，提取其file_uuid字段（sources字段）

  expected_output: >
    返回JSON数组格式的详细事件数据：
    **重要：所有输出必须使用简体中文，不能包含Unicode编码符号。**

    [
      {{
        "id": "j1",
        "text": "不超过100字；**关键词加粗**；异常值用<span style=\"color:#d0021b\">值</span>标红",
        "chief_surgeon": "如果是手术事件，且有主刀医生信息，才需要提取主刀医生的名字，否则为空",
        "examination_hospital": "如果是胃肠镜等大型检查事件，且有检查所在医院信息，才需要提取医院名称，否则为空",
        "sources": [{{"file_uuid": "来源文件UUID"}}]
      }}
    ]

  agent: patient_journey_details_generator

extract_indicator_series_task:
  description: >
    基于输入提取重要指标的时间序列数据，用于生成趋势图表。

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。
    每个config包含: disease_name（疾病名称）, dashboard_description（看板说明）。

    **【核心原则】严格按照dashboard_description中的要求提取指标：**

    1. **第一步：必须仔细阅读dashboard_description中的"关键指标趋势图"部分**
       - 该部分会明确列出需要提取的指标名称（如：AFP、PIVKA-II、CA199、肝功能指标、肿瘤大小等）
       - 这是你提取指标的唯一依据

    2. **第二步：严格按照列表提取，不得擅自添加**
       - **只提取dashboard_description中明确列出的指标**
       - **dashboard_description中没有提到的指标，即使患者数据中有，也不要提取**
       - 不要自作主张添加你认为"重要"但配置中未列出的指标

    3. **第三步：只返回有数据的指标**
       - **如果患者数据中完全没有某个指标的数据，不要返回该指标的空对象**
       - 例如：dashboard_description要求提取AFP、PIVKA-II、CA199，但患者数据中只有AFP和PIVKA-II的数据，没有CA199的数据
       - 那么只返回AFP和PIVKA-II两个指标对象，不要返回一个series为空数组的CA199对象
       - **核心原则：只返回实际有数据的指标，没有数据就不返回**

    4. **多疾病处理：**
       - 如果患者有多个疾病，需要提取所有疾病配置中列出的指标（取并集）

    5. **特殊情况：**
       - 只有当dashboard_description中完全没有"关键指标趋势图"部分，或者无法识别疾病时，才可以提取所有关键数值型指标
       - 这种情况应该是罕见的

    **示例说明：**
    - 假设dashboard_description中写着："关键指标趋势图：AFP、PIVKA-II、CA199、肝功能指标、肿瘤大小"
    - 那么你应该提取：
      ✅ AFP
      ✅ PIVKA-II
      ✅ CA199
      ✅ ALT、AST、总胆红素、白蛋白等肝功能相关指标
      ✅ 肿瘤大小（从影像报告中提取）
    - 你不应该提取：
      ❌ 血常规指标（白细胞、红细胞、血小板等）
      ❌ 肾功能指标（肌酐、尿素氮等）
      ❌ 凝血功能指标
      ❌ 其他任何未在配置中列出的指标
    - 即使患者数据中有这些指标的完整数据，也不要提取

    **任务目标：**
    从文本与结构化数据中筛选dashboard_description中明确要求的数值型指标。按时间升序输出 (time,value) 序列，time 为yyyy-MM-dd或yyyy-MM-dd HH:mm。

    **增量更新模式：**
    如果提供了现有指标序列数据，你需要：
    1. 保留现有指标序列中的所有历史数据点
    2. 将新的数据点添加到现有指标序列中，保持时间升序
    3. 如果发现相同时间点的数据，使用最新的值
    4. 确保数据的连续性和完整性

    输入：
    [系统日期]: {current_date}
    [患者文本]: {patient_content}
    [患者结构化数据]: {full_structure_data}
    [现有指标序列]: {existing_indicator_series}
    [疾病配置]: {disease_config}

    规则：
    - **首要规则：只提取dashboard_description中"关键指标趋势图"部分明确列出的指标**
    - **第二规则：只返回实际有数据的指标，患者数据中没有的指标不要返回空对象**
    - 仅基于提供的信息做客观提取，不得臆测。
    - 只提取数值型指标，忽略文本型结果。
    - 每个指标最多提取30个数据点，优先保留最新和最重要的数据点。
    - 数据点按时间升序排列。
    - 标注异常值（is_abnormal字段）。
    - 如果有参考范围，提取normal_min和normal_max。

  expected_output: >
    返回JSON数组格式的指标序列：
    注意：所有输出必须使用简体中文，不能包含Unicode编码符号（如\\u4e2d\\u6587等）。

    [
      {{
        "name": "指标名称",
        "unit": "单位(可选)",
        "series": [
          {{
            "time": "yyyy-MM-dd",
            "value": 数值,
            "is_abnormal": 布尔值
          }}
        ],
        "normal_min": "正常范围最小值，数值，可选",
        "normal_max": "正常范围最大值，数值，可选"
      }}
    ]

  agent: indicator_series_extractor 

generate_mdt_report_task:
  description: >
    基于患者结构化数据生成标准化的MDT简要报告，用于临床讨论和决策支持。报告需要包含患者基本信息、病史、关键检查结果、影像学等核心信息。

    **疾病配置：**
    输入参数中的disease_config字段包含了识别到的疾病配置信息列表。
    每个config包含: disease_name（疾病名称）, dashboard_description（看板说明）。

    **重要**：请仔细阅读dashboard_description中的说明，特别关注：
    - 实验室检查要求：需要在MDT报告中展示哪些检验指标
    - 影像学检查要求：需要展示哪些影像学检查结果
    - 病历事件回顾维度：报告应该包含哪些维度的信息

    根据看板说明中的要求来组织MDT报告的内容和结构。

    **增量更新模式：**
    如果提供了现有MDT报告数据，你需要：
    1. 保留现有报告中的历史信息，不要删除已有的检查结果和病史记录
    2. 将新的检查结果和诊断信息整合到现有报告中
    3. 更新实验室检查表格，添加新的检查数据，保持时间顺序
    4. 如果患者基本信息有更新，以最新信息为准
    5. 确保报告的完整性和时间连续性

    输入：
    [系统日期]: {current_date}
    [患者结构化数据]: {patient_structured_data}
    [患者文本]: {patient_content}
    [现有MDT报告]（如有）: {existing_mdt_report}

    报告要求：
    1. 标题：患者信息概览
    2. 一级标题：XXX（患者姓名）简要病史及辅助检查
       - 按时间顺序列出关键检查和诊断信息
       - 格式：日期 + 检查类型 + 关键结果描述
    3. 一级标题：既往史
       - 列出患者的既往病史、手术史、过敏史等
    4. 一级标题：实验室检查
       - 按开单时间分组的表格形式
       - **重要**：参考看板说明中的实验室检查要求，提取相关的检验指标
       - 表头：检查项目、开单时间、报告时间、项目名称、结果、参考值(正常区间)、异常提示(阴性、阳性、偏高、偏低)
    5. 一级标题：影像学检查
       - 列出患者的影像学检查结果，以表格形式呈现
       - 格式： 检查项目 + 报告关键结果原文 + 日期
       - 表头：检查项目、报告结果、检查时间

    格式化要求：
    - 使用简体中文输出
    - 确保信息准确、客观
    - 按时间顺序排列

  expected_output: >
    返回结构化的MDT报告数据，格式为JSON数组，每个元素包含type和content字段：
    {{"mdt_simple_report": 
    [
      {{ "type": "title", "content": "患者信息概览" }},
      {{ "type": "heading", "level": 1, "content": "XXX简要病史及辅助检查" }},
      {{ "type": "paragraph", "content": "病史和检查内容..." }},
      {{ "type": "heading", "level": 1, "content": "既往史" }},
      {{ "type": "paragraph", "content": "既往史内容..." }},
      {{ "type": "heading", "level": 1, "content": "实验室检查" }},
      {{ "type": "table", "headers": ["检查项目", "开单时间", "报告时间", "项目名称", "结果", "参考值(正常区间)", "异常提示"], "rows": [["血常规", "2025-01-01", "2025-01-01", "白细胞", "5.2", "3.5-9.5", "正常"]] }}
      {{ "type": "heading", "level": 1, "content": "影像学检查" }},
      {{ "type": "table", "headers": ["检查项目", "报告结果", "检查时间"], "rows": [["上腹部CT", "结果原文", "2025-01-01"]] }}
    ]}}
  agent: mdt_report_generator 