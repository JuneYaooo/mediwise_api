<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>患者治疗甘特图</title>
    <style>
        {{FONT_FACE_CSS}}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'CustomChinese', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            width: calc(100% - 40px);
            max-width: none;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .content {
            padding: 30px;
        }

        .gantt-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: visible;
        }

        #ganttChart {
            width: 100%;
            min-height: 800px;
            min-width: 2400px;
        }

        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #999;
            font-size: 18px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="content">
            <div class="loading" id="loading">正在加载治疗时间线</div>
            <div class="gantt-container" id="ganttContainer" style="display: none;">
                <div id="ganttChart"></div>
            </div>

            <div class="legend" id="legend" style="display: none;">
                <!-- 图例将由JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 引入 ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <script>
        // 注入的治疗数据
        const treatmentData = {{DATA_PLACEHOLDER}};

        // 定义治疗类别的颜色映射
        const categoryColors = {
            '外科治疗': '#FF6B6B',
            '局部治疗': '#4ECDC4',
            '系统治疗': '#45B7D1',
            '化疗': '#96CEB4',
            '靶免治疗': '#FFEAA7',
            '靶向治疗': '#DFE6E9',
            '免疫治疗': '#A29BFE',
            '中医药治疗': '#FD79A8',
            '辅助/支持治疗': '#FDCB6E',
            '其他治疗': '#B2BEC3'
        };

        // 获取颜色
        function getColor(category) {
            return categoryColors[category] || '#95A5A6';
        }

        function drawChart() {
            try {
                console.log('========== 甘特图渲染开始 ==========');
                console.log('治疗数据类型:', typeof treatmentData);
                console.log('治疗数据长度:', Array.isArray(treatmentData) ? treatmentData.length : 'N/A');
                console.log('治疗数据内容:', JSON.stringify(treatmentData, null, 2));

                if (!treatmentData || treatmentData.length === 0) {
                    const errorMsg = '暂无治疗数据 - 数据为空或未正确传入';
                    console.error(errorMsg);
                    document.getElementById('loading').textContent = errorMsg;
                    document.getElementById('loading').style.color = '#e74c3c';
                    return;
                }

                console.log('开始渲染甘特图，治疗记录数:', treatmentData.length);

                // 初始化 ECharts
                const chartDom = document.getElementById('ganttChart');
                const myChart = echarts.init(chartDom);

                // 收集所有类别用于图例
                const categories = new Set();

                // 准备数据：每条治疗记录单独占一行（不分组）
                const seriesData = [];
                const yAxisData = [];

                // 处理每条治疗记录
                let skippedCount = 0;
                let yAxisIndex = 0;

                treatmentData.forEach((treatment, index) => {
                    try {
                        console.log(`处理治疗 [${index}]:`, treatment);

                        // 验证日期数据
                        if (!treatment.start_date || treatment.start_date === '') {
                            console.error(`❌ 治疗 ${index} 缺少开始日期，已跳过:`, treatment);
                            skippedCount++;
                            return;
                        }

                        const startDate = new Date(treatment.start_date);
                        let endDate = treatment.end_date ? new Date(treatment.end_date) : null;

                        // 验证开始日期
                        if (isNaN(startDate.getTime())) {
                            console.error(`治疗的开始日期格式无效: "${treatment.start_date}"`);
                            skippedCount++;
                            return;
                        }

                        // 验证或设置结束日期
                        if (!endDate || isNaN(endDate.getTime())) {
                            endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + 1);
                        }

                        // 确保结束日期不早于开始日期
                        if (endDate < startDate) {
                            endDate = new Date(startDate);
                            endDate.setDate(endDate.getDate() + 1);
                        }

                        // 每条治疗占一行，Y轴标签显示：治疗类型 - 药物名称
                        const treatmentType = treatment.treatment_type || treatment.category || '未分类';
                        const drugName = treatment.matched_drug || treatment.methods_drugs || '未知';
                        const displayLabel = `${treatmentType}\n${drugName}`;
                        yAxisData.push(displayLabel);

                        categories.add(treatment.category);

                        // 系列数据：每条记录独立的Y轴索引
                        seriesData.push({
                            name: drugName,
                            value: [
                                yAxisIndex,  // 每条记录独立的Y轴索引
                                startDate.getTime(),
                                endDate.getTime(),
                                Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24))
                            ],
                            itemStyle: {
                                color: getColor(treatment.category),
                                borderRadius: 4
                            },
                            // 将剂量信息作为额外数据
                            dosage: treatment.dosage_label || '',
                            category: treatment.category,
                            treatment_type: treatment.treatment_type
                        });

                        console.log(`  [${index}] ${drugName}: ${treatment.start_date} ~ ${treatment.end_date || '(自动计算)'}`);
                        yAxisIndex++;

                    } catch (e) {
                        console.error(`❌ 处理治疗 ${index} 时出错:`, e, treatment);
                        skippedCount++;
                    }
                });

                console.log(`治疗数据处理完成: 总计${treatmentData.length}条, 跳过${skippedCount}条, 有效${treatmentData.length - skippedCount}条`);

                // 检查是否所有数据都被跳过了
                if (seriesData.length === 0) {
                    const errorMsg = `所有${treatmentData.length}条治疗记录都缺少有效日期，无法绘制甘特图`;
                    console.error('❌', errorMsg);
                    document.getElementById('loading').textContent = errorMsg;
                    document.getElementById('loading').style.color = '#e74c3c';
                    return;
                }

                // 动态计算图表高度（基于治疗记录数量）
                const itemHeight = 50;  // 每条记录的高度
                const baseHeight = 300;  // 基础高度（包含标题、轴标签等）
                const chartHeight = Math.max(800, baseHeight + seriesData.length * itemHeight);
                chartDom.style.height = chartHeight + 'px';

                console.log(`图表高度设置为: ${chartHeight}px (${seriesData.length} 条治疗记录)`);


                // 计算时间范围
                let minTime = Infinity;
                let maxTime = -Infinity;
                seriesData.forEach(item => {
                    if (item.value[1] < minTime) minTime = item.value[1];
                    if (item.value[2] > maxTime) maxTime = item.value[2];
                });

                // 添加一些padding（前后各加7天）
                const timePadding = 7 * 24 * 60 * 60 * 1000; // 7天
                minTime = minTime - timePadding;
                maxTime = maxTime + timePadding;

                console.log('时间范围:', new Date(minTime).toLocaleDateString('zh-CN'), '~', new Date(maxTime).toLocaleDateString('zh-CN'));

                console.log('系列数据准备完成 - 使用Custom系列渲染甘特图');

                // ECharts 配置 - 使用Custom系列实现甘特图
                const option = {
                    tooltip: {
                        formatter: function (params) {
                            if (!params.data) return '';
                            const data = params.data;
                            const startDate = new Date(data.value[1]).toLocaleDateString('zh-CN');
                            const endDate = new Date(data.value[2]).toLocaleDateString('zh-CN');
                            const dosage = data.dosage || '无剂量信息';
                            const duration = data.value[3];

                            return `<b>${data.name}</b><br/>
                                    类别: ${data.category}<br/>
                                    类型: ${data.treatment_type || '未分类'}<br/>
                                    开始: ${startDate}<br/>
                                    结束: ${endDate}<br/>
                                    持续: ${duration} 天<br/>
                                    剂量: ${dosage}`;
                        }
                    },
                    grid: {
                        left: 400,
                        right: 80,
                        top: 150,
                        bottom: 100,
                        containLabel: false
                    },
                    xAxis: {
                        type: 'time',
                        position: 'top',
                        min: minTime,
                        max: maxTime,
                        axisLabel: {
                            formatter: function(value) {
                                const date = new Date(value);
                                const year = date.getFullYear();
                                const month = date.getMonth() + 1;
                                const day = date.getDate();
                                return year + '/' + month + '/' + day;
                            },
                            fontSize: 12,
                            color: '#333',
                            fontWeight: 'bold',
                            fontFamily: 'CustomChinese, Microsoft YaHei',
                            rotate: 45,
                            interval: 'auto'
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#999',
                                width: 2
                            }
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#e0e0e0',
                                type: 'dashed'
                            }
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: yAxisData,
                        axisLabel: {
                            fontSize: 14,
                            color: '#333',
                            fontFamily: 'CustomChinese, Microsoft YaHei',
                            fontWeight: 'bold',
                            width: 360,
                            overflow: 'break',
                            interval: 0,
                            lineHeight: 20,
                            margin: 15
                        },
                        axisLine: {
                            lineStyle: {
                                color: '#999',
                                width: 2
                            }
                        },
                        axisTick: {
                            show: true,
                            length: 5
                        },
                        splitLine: {
                            show: true,
                            lineStyle: {
                                color: '#f0f0f0',
                                width: 1
                            }
                        }
                    },
                    series: [{
                        type: 'custom',
                        renderItem: function (params, api) {
                            // 获取数据：[yAxisIndex, startTime, endTime, duration]
                            const yAxisIndex = api.value(0);
                            const startTime = api.value(1);
                            const endTime = api.value(2);

                            // 转换为坐标
                            const startPoint = api.coord([startTime, yAxisIndex]);
                            const endPoint = api.coord([endTime, yAxisIndex]);

                            // 计算矩形参数
                            const height = api.size([0, 1])[1] * 0.6; // 条形高度为类别高度的60%
                            const width = endPoint[0] - startPoint[0];

                            // 获取颜色和其他样式
                            const itemStyle = api.style({
                                fill: api.visual('color'),
                                stroke: null
                            });

                            // 返回矩形图形
                            const rectShape = echarts.graphic.clipRectByRect({
                                x: startPoint[0],
                                y: startPoint[1] - height / 2,
                                width: width,
                                height: height
                            }, {
                                x: params.coordSys.x,
                                y: params.coordSys.y,
                                width: params.coordSys.width,
                                height: params.coordSys.height
                            });

                            if (!rectShape) {
                                return null;
                            }

                            // 准备文本标签（剂量信息）
                            const dosage = params.data ? params.data.dosage : '';
                            const textElements = [];

                            if (dosage && width > 50) { // 只有条形够宽时才显示剂量
                                textElements.push({
                                    type: 'text',
                                    style: {
                                        text: dosage,
                                        x: rectShape.x + rectShape.width / 2,
                                        y: rectShape.y + rectShape.height / 2,
                                        fill: '#000',
                                        fontSize: 11,
                                        fontFamily: 'CustomChinese, Microsoft YaHei',
                                        textAlign: 'center',
                                        textVerticalAlign: 'middle',
                                        textBackgroundColor: 'rgba(255, 255, 255, 0.8)',
                                        textBorderRadius: 2,
                                        textPadding: [2, 4]
                                    }
                                });
                            }

                            return {
                                type: 'group',
                                children: [
                                    {
                                        type: 'rect',
                                        shape: rectShape,
                                        style: itemStyle
                                    },
                                    ...textElements
                                ]
                            };
                        },
                        encode: {
                            x: [1, 2], // startTime 和 endTime 映射到 x 轴
                            y: 0       // yAxisIndex 映射到 y 轴
                        },
                        data: seriesData.map(item => ({
                            name: item.name,
                            value: item.value, // [yAxisIndex, startTime, endTime, duration]
                            itemStyle: item.itemStyle,
                            dosage: item.dosage,
                            category: item.category,
                            treatment_type: item.treatment_type
                        }))
                    }]
                };

                myChart.setOption(option);
                console.log('ECharts甘特图渲染完成');

                // 隐藏加载提示，显示图表
                document.getElementById('loading').style.display = 'none';
                document.getElementById('ganttContainer').style.display = 'block';
                document.getElementById('legend').style.display = 'flex';

                // 生成图例
                generateLegend(categories);

                // 标记渲染完成 - 创建一个隐藏的marker元素供Playwright检测
                const marker = document.createElement('div');
                marker.className = 'chart-ready';
                marker.style.display = 'none';
                document.body.appendChild(marker);

                // 窗口调整大小时重新渲染
                window.addEventListener('resize', function() {
                    myChart.resize();
                });

            } catch (error) {
                console.error('绘制甘特图失败:', error);
                document.getElementById('loading').textContent = '绘制甘特图时发生错误';
            }
        }

        function generateLegend(categories) {
            const legendContainer = document.getElementById('legend');
            legendContainer.innerHTML = '';

            categories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'legend-item';

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = getColor(category);

                const label = document.createElement('span');
                label.textContent = category;

                item.appendChild(colorBox);
                item.appendChild(label);
                legendContainer.appendChild(item);
            });
        }

        // 页面加载完成后绘制
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', drawChart);
        } else {
            drawChart();
        }
    </script>
</body>
</html>
